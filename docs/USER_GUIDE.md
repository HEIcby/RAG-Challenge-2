# 金盘科技 RAG 问答系统 - 用户指南

## 📖 目录

- [快速开始](#快速开始)
- [系统功能](#系统功能)
- [多轮对话](#多轮对话)
- [问题库](#问题库)
- [网络访问](#网络访问)
- [常见问题](#常见问题)

---

## 🚀 快速开始

### 前提条件

确保已完成数据准备：
- ✅ PDF 文件已解析
- ✅ 向量数据库已创建
- ✅ 数据目录存在: `data/val_set/databases/`

### 启动方式

**方法 1: 一键启动（推荐）**
```bash
./scripts/start_frontend.sh
```

**方法 2: 直接运行**
```bash
streamlit run app_jinpan_qa.py
```

**方法 3: Python 模块方式**
```bash
python3 -m streamlit run app_jinpan_qa.py
```

### 访问地址

启动后在浏览器访问：
- **本机访问**: http://localhost:8502
- **局域网访问**: http://[你的IP]:8502

---

## 🎯 系统功能

### 1. 深度分析模式

系统固定使用 **jingpan（精盘）** 模式，提供：
- ✅ 详细的推理过程
- ✅ 数据来源标注
- ✅ 逐步分析说明
- ✅ 相关页码引用

**为什么锁定 jingpan？**
- 包容性强：能处理 number、name、boolean 等所有类型问题
- 准确性高：详细推理链（Chain-of-Thought）提升答案质量
- 可验证性：用户可以看到答案的推导依据

### 2. 检索配置

在侧边栏可调整：

| 参数 | 范围 | 默认值 | 说明 |
|------|------|--------|------|
| 检索数量 | 5-30 | 10 | 每次检索返回的文档块数量 |
| HYDE | 开/关 | 开启 | 假设性文档扩展，提高检索相关性 |
| Multi-Query | 开/关 | 开启 | 多查询扩展，提高召回率 |
| LLM 重排序 | 开/关 | 开启 | 使用 LLM 对检索结果重新排序 |

**推荐配置**：
- 一般问题：保持默认设置
- 复杂问题：增加检索数量到 20-30
- 简单问题：可关闭 HYDE 和 Multi-Query 以加快速度

### 3. 系统状态

侧边栏显示：
- ✅ 系统初始化状态
- 🏢 当前公司：金盘科技
- 💬 历史问答条数

**操作按钮**：
- 🔄 重新初始化系统
- 💾 保存问答历史（JSON格式）
- 🗑️ 清空对话历史

---

## 💬 多轮对话

### 功能概述

系统支持智能多轮对话，能够：
- 理解指代词（"它"、"这个"、"这些"）
- 处理省略主语的追问
- 自动关联历史上下文
- 支持对比分析

### 核心机制

**方案B：分离检索和生成**

1. **检索阶段**：使用原始问题进行检索（保证精确性）
2. **生成阶段**：将历史对话与当前问题结合，传递给 LLM（利用上下文）

### 配置选项

在侧边栏的 "💬 多轮对话设置"：

**1. 启用/关闭多轮对话**
- 默认：✅ 启用
- 作用：控制是否使用历史对话作为上下文

**2. 保留对话轮数**
- 范围：1-10 轮
- 默认：3 轮
- 说明：轮数越多，上下文越丰富，但 token 消耗越大

**建议设置**：
- 简单问答：1-2 轮
- 复杂分析：3-5 轮
- 深度探讨：5-10 轮

### 使用场景

**场景 1：指代消解**
```
第1轮: "2024年第一季度的营业收入是多少？"
系统: "1.5亿元人民币"

第2轮: "它相比去年增长了多少？"  ← "它"指营业收入
系统: 自动理解上下文，查询 2023 年数据进行对比
```

**场景 2：延续性提问**
```
第1轮: "公司的主要产品有哪些？"
系统: "干式变压器、配电变压器..."

第2轮: "这些产品的市场份额如何？"  ← "这些产品"指前面列举的
系统: 关联产品列表，查询市场数据
```

**场景 3：对比分析**
```
第1轮: "2023年的净利润是多少？"
第2轮: "2024年呢？"  ← 延续前面的问题
第3轮: "增长率是多少？"  ← 需要对比前两轮数据
系统: 综合三轮对话，给出增长率分析
```

### Token 消耗估算

| 对话轮数 | 额外消耗 | 适用场景 |
|---------|---------|---------|
| 1 轮 | +100 tokens | 简单指代 |
| 3 轮 | +300 tokens | 一般对话 |
| 5 轮 | +500 tokens | 深度分析 |
| 10 轮 | +1000 tokens | 长对话 |

---

## 📚 问题库

### 概述

系统集成了 **127个真实投资者问题**，涵盖金盘科技各个方面。

### 问题类型

| 类型 | 数量 | 典型问题 |
|------|------|---------|
| 海外业务 | 19 | 美国工厂产能、关税影响、马来西亚工厂 |
| 财务管理 | 10 | 应收账款、现金流、财务指标优化 |
| 业务拓展 | 10 | 机器人公司、数据资产、新业务 |
| 客户关系 | 9 | 字节跳动、特斯拉、微软合作 |
| 战略规划 | 8 | 十五五规划、全球化布局 |
| 产品技术 | 7 | SST技术、BBU概念、技术优势 |
| 技术应用 | 7 | DeepSeek部署、AI赋能 |
| 订单情况 | 6 | 在手订单、订单充足性 |
| 政策影响 | 6 | 关税政策、免税政策、封关影响 |
| 其他 | 45+ | 项目合作、研发进展等 |

### 使用方法

**1. 类型筛选**
- 点击下拉菜单选择问题类型
- 系统自动显示该类型的问题
- 显示当前类型的问题数量

**2. 随机问题**
- 点击 "🎲 随机问题" 按钮
- 从127个问题中随机选择
- 自动填入输入框

**3. 浏览选择**
- 3列网格显示，每列约5个问题
- 长问题自动截断为 "前47字符..."
- 点击问题自动填入输入框

**4. 多轮测试**

利用问题库测试多轮对话：

```
步骤1: 选择类型 "产品技术"
步骤2: 点击 "公司SST产品有什么技术优势？"
步骤3: 获取答案后，继续点击 "请问公司在SST最新的进展情况？"
步骤4: 再点击 "SST产品的未来市场拓展计划？"
```

### 热门问题精选

**财务类**:
- "请问公司一季度扣非利润下滑的原因是什么？"
- "近年来公司应收账款有所增加，具体原因是什么？"

**技术类**:
- "公司与英伟达合作开发SST固态变压器是真的吗？"
- "请问贵公司是否已经部署了DeepSeek？"

**客户类**:
- "请问字节跳动是否为公司客户"
- "贵司与特斯拉是否有合作"

**战略类**:
- "公司2025年的总体经营目标？"
- "十五五期间的发展方向是什么？"

---

## 🌐 网络访问

### 本地访问

```
http://localhost:8502
```

### 局域网访问

同一 WiFi/局域网下的任何设备都可以访问：

```
http://[你的IP地址]:8502
```

**查找你的 IP 地址**：

macOS/Linux:
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

Windows:
```cmd
ipconfig | findstr IPv4
```

**支持的设备**：
- ✅ 其他电脑（Windows、Mac、Linux）
- ✅ 手机（iPhone、Android）
- ✅ 平板（iPad、Android平板）
- ✅ 智能电视（如果支持浏览器）

### 防火墙设置

如果无法访问，可能需要允许端口 8502：

**macOS**:
```bash
# 一般情况下 macOS 防火墙不会阻止本地网络
# 如需检查：系统偏好设置 > 安全性与隐私 > 防火墙
```

**Windows**:
```cmd
# 允许 8502 端口
netsh advfirewall firewall add rule name="Streamlit" dir=in action=allow protocol=TCP localport=8502
```

**Linux**:
```bash
# Ubuntu/Debian
sudo ufw allow 8502

# CentOS/RHEL
sudo firewall-cmd --zone=public --add-port=8502/tcp --permanent
sudo firewall-cmd --reload
```

---

## ❓ 常见问题

### Q1: 为什么只显示15个问题？

**A**: 为避免页面过长影响体验。可通过类型筛选查看不同问题集，或使用随机按钮探索。

### Q2: 多轮对话不生效？

**A**: 检查侧边栏是否启用了 "💬 多轮对话设置"，确保至少保留1轮对话。

### Q3: 如何清空历史重新开始？

**A**: 点击侧边栏的 "🗑️ 清空对话历史" 按钮。

### Q4: 答案生成时间过长？

**A**: 可能原因：
- 检索数量设置过高（降低到10-15）
- 启用了多个增强功能（可暂时关闭 HYDE 或 Multi-Query）
- 网络延迟（检查 API 连接）

### Q5: 系统支持哪些公司？

**A**: 当前版本专为金盘科技定制，仅支持该公司的年报数据。

### Q6: 可以添加自己的问题吗？

**A**: 可以！直接编辑 `data/val_set/questions.csv`：
```csv
序号,提问内容,公司名称,问题类型
128,你的新问题,金盘科技,自定义类型
```

### Q7: 如何导出问答历史？

**A**: 点击侧边栏 "💾 保存问答历史"，会生成 `qa_history_YYYYMMDD_HHMMSS.json` 文件。

### Q8: 移动端使用体验如何？

**A**: Streamlit 对移动端有基本支持，但建议在电脑或平板上使用以获得最佳体验。

### Q9: 系统是否支持英文问题？

**A**: 当前针对中文优化，英文问题可以尝试，但效果可能不如中文。

### Q10: API Key 在哪里配置？

**A**: API Key 已预配置在 `app_jinpan_qa.py` 中：
- DASHSCOPE_API_KEY (Qwen)
- GOOGLE_API_KEY (Gemini)

如需修改，编辑文件第16-17行。

---

## 🔧 高级配置

### 性能优化

**1. 调整检索参数**
```python
# 在侧边栏设置
检索数量: 10-15  # 平衡速度和质量
LLM 重排序: 开启  # 提高相关性
```

**2. 多轮对话优化**
```python
保留轮数: 3  # 大多数场景足够
轮数过多会增加 token 消耗和响应时间
```

### 自定义样式

系统使用自定义 CSS，可在 `app_jinpan_qa.py` 中修改（第33-95行）：

```python
st.markdown("""
<style>
.answer-box {
    background-color: #f8f9fa;  # 答案框背景色
    color: #212529;              # 文字颜色
    ...
}
</style>
""", unsafe_allow_html=True)
```

### 数据更新

添加新的年报数据：

1. 将 PDF 文件放入 `data/val_set/pdf_reports/`
2. 更新 `data/val_set/subset.csv`
3. 重新运行：
```bash
python main.py parse-pdfs --data-dir data/val_set
python main.py process-reports --data-dir data/val_set
```
4. 重启前端

---

## 📞 技术支持

### 项目信息

- **项目**: RAG Challenge Winner Solution
- **公司**: 金盘科技
- **技术栈**: Streamlit + Qwen + FAISS
- **版本**: v1.0

### 相关文档

- 项目结构：`PROJECT_STRUCTURE.md`
- 原始 README：`README.md`
- 问题库文件：`data/val_set/questions.csv`

### 反馈与贡献

如有问题或建议，请：
1. 查看项目 Issues
2. 提交 Pull Request
3. 联系项目维护者

---

**最后更新**: 2025-11-06  
**文档版本**: 1.0
